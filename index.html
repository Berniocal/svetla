<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Barvy – multiplayer</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111" />
  <style>
    :root { --bg:#0f1115; --card:#171a22; --text:#e9ecf1; --muted:#aab2c0; }
    html,body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: var(--bg); color: var(--text); }
    .wrap { max-width: 560px; margin: 0 auto; padding: 16px; }
    .card { background: var(--card); border-radius: 16px; padding: 14px; margin: 10px 0; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input, button, select { font-size: 16px; padding: 12px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.12); background: #0f1218; color: var(--text); }
    input { width: 100%; box-sizing: border-box; }
    button { cursor:pointer; border: 0; background: #2a66ff; }
    button.secondary { background:#2b3242; }
    button.danger { background:#d64545; }
    .muted { color: var(--muted); font-size: 13px; line-height: 1.35; }
    .big { font-size: 20px; font-weight: 700; }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; letter-spacing: 2px; font-size: 22px; }
    .pill { padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,.08); font-size: 13px; }
    .table { width:100%; border-collapse: collapse; font-size: 14px; }
    .table th,.table td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,.08); text-align:left; }

    /* Fullscreen color */
    .fullScreen {
      position: fixed; inset: 0; display: none;
      align-items: center; justify-content: center; flex-direction: column;
      touch-action: manipulation;
    }
    .fsText { font-size: 28px; font-weight: 900; text-shadow: 0 2px 14px rgba(0,0,0,.35); }
    .fsSub { margin-top: 10px; font-size: 14px; opacity:.9; }
    .tapHint { margin-top: 18px; font-size: 16px; padding: 10px 14px; border-radius: 999px; background: rgba(0,0,0,.18); }

    /* Fullscreen idle (ztmavení) */
    .idleScreen{
      position: fixed; inset: 0;
      display: none;
      background: #000;
    }
  </style>
</head>
<body>
  <div class="wrap" id="appWrap">
    <div class="card">
      <div class="big">Multiplayer „Barvy na telefonech“3</div>
      <div class="muted">Host jen ovládá a vidí výsledky. Herní telefony jsou během hry buď barva fullscreen, nebo úplná tma.</div>
    </div>

    <div class="card" id="joinCard">
      <div class="row">
        <div class="pill" id="rolePill">Nepřipojeno</div>
        <div class="pill" id="connPill">offline</div>
      </div>
      <div style="height:10px"></div>

      <label class="muted">Tvoje přezdívka (volitelné)</label>
      <input id="nameInput" placeholder="např. Honza" />

      <div style="height:10px"></div>
      <label class="muted">Kód místnosti (5 číslic)</label>
      <input id="codeInput" inputmode="numeric" maxlength="5" placeholder="12345" />

      <div style="height:10px"></div>
      <div class="row">
        <button id="btnJoin">Připojit / založit</button>
        <button class="secondary" id="btnRandom">Vygenerovat kód</button>
      </div>
      <div class="muted" style="margin-top:8px">
        První telefon, který místnost založí, je <b>host</b>. Host není součástí hry.
      </div>
    </div>

    <div class="card" id="hostCard" style="display:none">
      <div class="big">Host – nastavení</div>
      <div class="muted">Počet hráčů = počet barev. Čas na stisk = timeout. Délka hry = automatický stop.</div>

      <div style="height:10px"></div>
      <label class="muted">Počet hráčů (2–10)</label>
      <select id="playersCount">
        <option>2</option><option>3</option><option selected>4</option><option>5</option><option>6</option>
        <option>7</option><option>8</option><option>9</option><option>10</option>
      </select>

      <div style="height:10px"></div>
      <label class="muted">Čas na stisk (ms)</label>
      <input id="durationMs" inputmode="numeric" value="1800" />

      <div style="height:10px"></div>
      <label class="muted">Délka hry (s) – po vypršení se sama zastaví</label>
      <input id="gameLengthSec" inputmode="numeric" value="60" />

      <div style="height:10px"></div>
      <div class="row">
        <button id="btnApply">Uložit nastavení</button>
        <button id="btnStart">Start hry</button>
        <button class="danger" id="btnStop">Stop</button>
        <button class="secondary" id="btnReset">Vynulovat skóre</button>
      </div>

      <div style="height:10px"></div>
      <div class="muted">Připojené telefony (včetně hosta): <span id="devicesCount">0</span></div>
    </div>

    <div class="card" id="statusCard" style="display:none">
      <div class="row">
        <div class="pill">Místnost: <span class="code" id="roomCodeLabel">-----</span></div>
        <div class="pill">Kolo: <span id="roundLabel">0</span></div>
        <div class="pill">Stav: <span id="phaseLabel">-</span></div>
      </div>
      <div style="height:10px"></div>
      <div class="muted" id="statusLine">Čekám…</div>
    </div>

    <div class="card" id="scoreCard" style="display:none">
      <div class="big">Skóre</div>
      <table class="table" id="scoreTable">
        <thead>
          <tr><th>Barva</th><th>Body</th><th>Prům. čas (ms)</th><th>Miss</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="muted" style="margin-top:8px">Tip: Polož telefony po zemi, zapni jas a vypni uspávání displeje.</div>
    </div>
  </div>

  <!-- Fullscreen color -->
  <div class="fullScreen" id="fs">
    <div class="fsText" id="fsText">Tvoje barva!</div>
    <div class="tapHint">Klepni kamkoliv</div>
    <div class="fsSub" id="fsSub">…</div>
  </div>

  <!-- Fullscreen idle (ztmavení) -->
  <div class="idleScreen" id="idle"></div>

  <!-- Firebase (compat for simple CDN usage) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

  <script>
    // ========== 0) Firebase config ==========
    const firebaseConfig = {
      apiKey: "AIzaSyDgMBr7Qv_EEa83TWS174eJdQW9xbgcSX0",
      authDomain: "barvy-multiplayer.firebaseapp.com",
      databaseURL: "https://barvy-multiplayer-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "barvy-multiplayer",
      storageBucket: "barvy-multiplayer.appspot.com",
      messagingSenderId: "1013627563036",
      appId: "1:1013627563036:web:83e19f570dd9a51d9143d9"
    };
    // =======================================

    // PWA SW
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    }

    // Helpers
    const $ = (id)=>document.getElementById(id);
    const now = ()=>Date.now();
    const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
    const randInt = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;

    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    // Device identity
    const deviceId = (() => {
      const k = "barvy_deviceId";
      let v = localStorage.getItem(k);
      if (!v) { v = "d_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16); localStorage.setItem(k,v); }
      return v;
    })();

    // UI refs
    const appWrap = $("appWrap");
    const joinCard = $("joinCard");
    const hostCard = $("hostCard");
    const statusCard = $("statusCard");
    const scoreCard = $("scoreCard");
    const rolePill = $("rolePill");
    const connPill = $("connPill");

    const nameInput = $("nameInput");
    const codeInput = $("codeInput");
    const btnJoin = $("btnJoin");
    const btnRandom = $("btnRandom");

    const playersCount = $("playersCount");
    const durationMs = $("durationMs");
    const gameLengthSec = $("gameLengthSec");

    const btnApply = $("btnApply");
    const btnStart = $("btnStart");
    const btnStop = $("btnStop");
    const btnReset = $("btnReset");
    const devicesCount = $("devicesCount");

    const roomCodeLabel = $("roomCodeLabel");
    const statusLine = $("statusLine");
    const roundLabel = $("roundLabel");
    const phaseLabel = $("phaseLabel");

    const scoreTableBody = $("scoreTable").querySelector("tbody");

    const fs = $("fs");
    const fsText = $("fsText");
    const fsSub = $("fsSub");
    const idle = $("idle");

    // Colors (až 10)
    const COLORS = [
      {key:"red",    label:"Červená",  css:"#ff3b30"},
      {key:"green",  label:"Zelená",   css:"#34c759"},
      {key:"blue",   label:"Modrá",    css:"#007aff"},
      {key:"yellow", label:"Žlutá",    css:"#ffd60a"},
      {key:"purple", label:"Fialová",  css:"#af52de"},
      {key:"orange", label:"Oranžová", css:"#ff9500"},
      {key:"pink",   label:"Růžová",   css:"#ff2d55"},
      {key:"cyan",   label:"Azurová",  css:"#5ac8fa"},
      {key:"lime",   label:"Limet",    css:"#bfff00"},
      {key:"white",  label:"Bílá",     css:"#ffffff"},
    ];

    function colorByKey(k){
      return COLORS.find(x=>x.key===k) || {key:k,label:k,css:"#222"};
    }

    // Firebase state
    let app, db;
    let roomCode = null;
    let isHost = false;
    let roomRef = null;
    let stateRef = null;
    let devicesRef = null;
    let actionsRef = null;
    let playersRef = null;

    // Host runtime
    let hostRunning = false;
    let stopTimer = null;

    // ✅ nový host ticker na timeouty konkrétních telefonů
    let hostTickTimer = null;

    function setConn(ok) {
      connPill.textContent = ok ? "online" : "offline";
      connPill.style.background = ok ? "rgba(52,199,89,.18)" : "rgba(214,69,69,.18)";
    }

    function genCode() { return String(randInt(0,99999)).padStart(5,"0"); }

    function renderScore(playersObj) {
      scoreTableBody.innerHTML = "";
      if (!playersObj) return;
      Object.values(playersObj).forEach(p => {
        const avg = p.hits > 0 ? Math.round(p.totalMs / p.hits) : "—";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.label}</td>
          <td>${p.hits||0}</td>
          <td>${avg}</td>
          <td>${p.miss||0}</td>
        `;
        scoreTableBody.appendChild(tr);
      });
    }

    // ✅ schování/zobrazení UI (data nesmí být vidět na herních telefonech během running)
    function hideUI(){ appWrap.style.display = "none"; }
    function showUI(){ appWrap.style.display = ""; }

    function showFullscreen(colorCss, label, extra) {
      hideUI();
      idle.style.display = "none";
      fs.style.display = "flex";
      fs.style.background = colorCss;
      fsText.textContent = label;
      fsSub.textContent = extra || "";
    }
    function hideFullscreen() {
      fs.style.display = "none";
    }
    function showIdle() {
      hideUI();
      hideFullscreen();
      idle.style.display = "block";
    }
    function hideIdle() {
      idle.style.display = "none";
    }

    async function ensureFirebase() {
      if (!app) {
        app = firebase.initializeApp(firebaseConfig);
        db = firebase.database();

        // real connection indicator
        db.ref(".info/connected").on("value", (snap) => setConn(!!snap.val()));
      }
    }

    async function joinOrCreate(code) {
      await ensureFirebase();
      roomCode = code;
      roomRef = db.ref("rooms/" + roomCode);
      stateRef = roomRef.child("state");
      devicesRef = roomRef.child("devices");
      actionsRef = roomRef.child("actions");
      playersRef = roomRef.child("players");

      roomCodeLabel.textContent = roomCode;
      statusCard.style.display = "";
      scoreCard.style.display = "";

      // presence
      const myName = (nameInput.value || "").trim() || "Telefon";
      const myDeviceRef = devicesRef.child(deviceId);
      await myDeviceRef.set({ name: myName, joinedAt: now(), lastSeen: now() });
      myDeviceRef.onDisconnect().remove();
      setInterval(()=> myDeviceRef.update({ lastSeen: now() }).catch(()=>{}), 5000);

      // determine host
      const snap = await stateRef.child("hostId").get();
      if (!snap.exists()) {
        try {
          const res = await stateRef.child("hostId").transaction(v => v || deviceId);
          isHost = res.committed && res.snapshot.val() === deviceId;
        } catch { isHost = false; }
      } else {
        isHost = (snap.val() === deviceId);
      }

      rolePill.textContent = isHost ? "HOST" : "HRÁČ";
      rolePill.style.background = isHost ? "rgba(42,102,255,.22)" : "rgba(255,214,10,.18)";
      hostCard.style.display = isHost ? "" : "none";

      // init defaults if host and missing
      if (isHost) {
        const st = await stateRef.get();
        if (!st.exists() || !st.val()?.phase) await initRoomDefaults();
      }

      // devices count
      devicesRef.on("value", snap2 => {
        const v = snap2.val() || {};
        devicesCount.textContent = Object.keys(v).length;
      });

      // players score
      playersRef.on("value", snap2 => renderScore(snap2.val()));

      // state
      stateRef.on("value", snap2 => onState(snap2.val() || {}));

      // actions (host only)
      if (isHost) {
        actionsRef.limitToLast(200).on("child_added", snap2 => onAction(snap2.val()));
      }
    }

    async function initRoomDefaults() {
      const n = clamp(parseInt(playersCount.value,10)||4,2,10);
      const dur = clamp(parseInt(durationMs.value,10)||1800,200,20000);
      const gls = clamp(parseInt(gameLengthSec.value,10)||60,1,36000);

      const players = {};
      for (let i=0;i<n;i++) {
        const c = COLORS[i];
        players[c.key] = { key:c.key, label:c.label, css:c.css, hits:0, miss:0, totalMs:0 };
      }
      await playersRef.set(players);
      await stateRef.update({
        phase: "lobby",
        playersCount: n,
        durationMs: dur,
        gameLengthSec: gls,

        // původní pole nechávám, ale nově se nepoužívají jako jediný cíl:
        round: 0,
        currentDevice: null,
        currentColor: null,
        shownAt: null,
        resolved: false,

        hostRunning: false,
        gameStartedAt: null,
        gameEndsAt: null,

        // ✅ nové mapy: deviceId -> colorKey | null, deviceId -> shownAt(ms)
        deviceColors: null,
        shownAtMap: null
      });
    }

    function onState(st) {
      roundLabel.textContent = st.round || 0;
      phaseLabel.textContent = st.phase || "-";

      // HOST: UI vidí vždy
      if (isHost) {
        showUI();
        hideFullscreen();
        hideIdle();
        statusLine.textContent =
          st.phase === "running"
            ? "Hra běží… (host není ve hře)"
            : (st.phase === "lobby" ? "Lobby – nastav a dej Start." : (st.phase === "stopped" ? "Stop." : "…"));
        return;
      }

      // HRÁČ: lobby/stop -> UI vidět může; running -> UI nikdy
      if (st.phase === "lobby") {
        showUI();
        statusLine.textContent = "Lobby – čekám na start od hosta…";
        hideFullscreen(); hideIdle();
        return;
      }

      if (st.phase === "running") {
        // ✅ v running je UI skryté a rozhoduje jen deviceColors
        const dc = st.deviceColors || {};
        const myColorKey = dc[deviceId] || null;

        if (myColorKey) {
          const c = colorByKey(myColorKey);
          showFullscreen(c.css, c.label, "Klepni kamkoliv");
        } else {
          showIdle();
        }
        return;
      }

      if (st.phase === "stopped") {
        showUI();
        statusLine.textContent = "Stop.";
        hideFullscreen(); hideIdle();
      }
    }

    // ====== HOST HELPERS pro nová pravidla ======

    async function getHostId(){
      return (await stateRef.child("hostId").get()).val();
    }

    async function getConnectedGameDevices() {
      const devSnap = await devicesRef.get();
      const devObj = devSnap.val() || {};
      let ids = Object.keys(devObj);

      const hostId = await getHostId();
      ids = ids.filter(id => id !== hostId);
      return ids;
    }

    function buildInitialDeviceColors(gameDevices, nPlayers) {
      // gameDevices může být víc než nPlayers -> některé budou null (tmavé)
      const ids = shuffle(gameDevices);
      const dc = {};
      const shownAtMap = {};
      const colors = COLORS.slice(0, nPlayers).map(c=>c.key);

      // všem nastav null (tmavé)
      for (const id of ids) {
        dc[id] = null;
      }

      // prvním N telefonům přiřaď N barev (každá právě 1×)
      for (let i=0;i<nPlayers;i++){
        const devId = ids[i];
        const colorKey = colors[i];
        dc[devId] = colorKey;
        shownAtMap[devId] = now();
      }

      return { dc, shownAtMap };
    }

    function getColoredDevices(dc){
      return Object.keys(dc || {}).filter(d=>!!dc[d]);
    }
    function getIdleDevices(dc){
      return Object.keys(dc || {}).filter(d=>!dc[d]);
    }

    function findDeviceByColor(dc, colorKey){
      for (const [d,c] of Object.entries(dc||{})){
        if (c === colorKey) return d;
      }
      return null;
    }

    // ✅ jediná funkce, která udělá přesun/swap podle pravidel
    async function hostHandleEventForDevice(deviceIdThatTriggered, reason) {
      // reason: "tap" | "timeout"
      const st = (await stateRef.get()).val() || {};
      if (st.phase !== "running") return;

      // auto-stop when time ends
      if (st.gameEndsAt && now() >= st.gameEndsAt) {
        hostRunning = false;
        await stateRef.update({ phase:"stopped", hostRunning:false });
        return;
      }

      // zkontroluj, že je pořád dost telefonů
      const gameDevices = await getConnectedGameDevices();
      const nPlayers = clamp(parseInt(st.playersCount||4,10),2,10);
      if (gameDevices.length < nPlayers) {
        hostRunning = false;
        await stateRef.update({ phase:"stopped", hostRunning:false });
        return;
      }

      let dc = st.deviceColors || {};
      let shownAtMap = st.shownAtMap || {};

      // pokud do hry někdo přibyl/ubylo zařízení, doplň klíče (nové zařízení = tmavé)
      for (const id of gameDevices) {
        if (!(id in dc)) dc[id] = null;
      }
      for (const id of Object.keys(dc)) {
        if (!gameDevices.includes(id)) {
          // odpojený telefon odeber
          delete dc[id];
          delete shownAtMap[id];
        }
      }

      const currentColor = dc[deviceIdThatTriggered] || null;
      if (!currentColor) {
        // ťuknutí na tmavý telefon ignorujeme
        return;
      }

      const dur = clamp(parseInt(st.durationMs||1800,10),200,20000);

      // statistiky: tap => hit+reaction, timeout => miss
      if (reason === "tap") {
        const tShown = shownAtMap[deviceIdThatTriggered] || st.gameStartedAt || now();
        const reaction = Math.max(0, now() - tShown);

        await playersRef.child(currentColor).transaction(p => {
          if (!p) return p;
          p.hits = (p.hits||0) + 1;
          p.totalMs = (p.totalMs||0) + reaction;
          return p;
        });
      } else if (reason === "timeout") {
        await playersRef.child(currentColor).transaction(p => {
          if (!p) return p;
          p.miss = (p.miss||0) + 1;
          return p;
        });
      }

      // pravidlo: pokud existuje tmavý telefon, barva se přesune tam a původní ztmavne
      const idle = getIdleDevices(dc);
      const colored = getColoredDevices(dc);

      // kolik máme "herních" zařízení momentálně v mapě (může být víc než hráčů)
      const coloredCount = colored.length; // mělo by být = nPlayers vždy (udržíme)
      const hasIdle = idle.length > 0;

      const updates = {};

      if (hasIdle) {
        // move color -> random idle phone
        const targetIdle = idle[randInt(0, idle.length-1)];

        // původní ztmavne
        dc[deviceIdThatTriggered] = null;
        delete shownAtMap[deviceIdThatTriggered];

        // cílový ztmavený dostane barvu
        dc[targetIdle] = currentColor;
        shownAtMap[targetIdle] = now();

      } else {
        // žádný tmavý telefon (počet telefonů == počet hráčů) => SWAP s jiným barevným telefonem
        const others = colored.filter(d => d !== deviceIdThatTriggered);
        if (others.length === 0) return; // bezpečnost

        const swapWith = others[randInt(0, others.length-1)];
        const otherColor = dc[swapWith];

        // swap
        dc[deviceIdThatTriggered] = otherColor;
        dc[swapWith] = currentColor;

        // reset časů obou (nová „výzva“)
        shownAtMap[deviceIdThatTriggered] = now();
        shownAtMap[swapWith] = now();
      }

      // pojistka: držet invariant "každá barva právě jednou"
      // (v praxi to invariantně drží výše, ale kdyby došlo k rozhození mapy, opravíme)
      const activeColors = COLORS.slice(0, nPlayers).map(c=>c.key);
      const count = {};
      for (const k of activeColors) count[k]=0;
      for (const d of Object.keys(dc)) {
        const c = dc[d];
        if (c && (c in count)) count[c]++;
      }

      // pokud nějaká barva chybí nebo je 2×, opravíme přeskládáním do prvních N telefonů
      const bad = activeColors.some(k => count[k] !== 1);
      if (bad) {
        // znovu vytvoř mapování podle aktuálně připojených telefonů (tmavé navíc)
        const rebuilt = buildInitialDeviceColors(gameDevices, nPlayers);
        dc = rebuilt.dc;
        shownAtMap = rebuilt.shownAtMap;
      }

      // zvýšíme "kolo" jako počet událostí
      const newRound = (st.round||0) + 1;

      await stateRef.update({
        deviceColors: dc,
        shownAtMap: shownAtMap,
        round: newRound
      });
    }

    // host ticker: timeouty pro jednotlivé telefony s barvou
    async function hostTick() {
      if (!isHost || !hostRunning) return;

      const st = (await stateRef.get()).val() || {};
      if (st.phase !== "running") return;

      // auto-stop when time ends
      if (st.gameEndsAt && now() >= st.gameEndsAt) {
        hostRunning = false;
        await stateRef.update({ phase:"stopped", hostRunning:false });
        return;
      }

      const dur = clamp(parseInt(st.durationMs||1800,10),200,20000);
      const dc = st.deviceColors || {};
      const shownAtMap = st.shownAtMap || {};

      // zkontroluj expirace pro každý telefon s barvou
      for (const devId of Object.keys(dc)) {
        const colorKey = dc[devId];
        if (!colorKey) continue;

        const tShown = shownAtMap[devId] || 0;
        if (tShown && (now() - tShown) >= dur) {
          // timeout pro konkrétní telefon
          await hostHandleEventForDevice(devId, "timeout");
          // po jednom timeoutu stačí skončit, další se dořeší v dalším ticku (méně kolizí)
          return;
        }
      }
    }

    async function onAction(act) {
      if (!isHost) return;
      if (!hostRunning) return;
      if (!act || act.type !== "tap") return;

      const st = (await stateRef.get()).val() || {};
      if (st.phase !== "running") return;

      // jen ťuknutí na telefon, který má barvu (jinak ignore)
      const dc = st.deviceColors || {};
      if (!dc[act.deviceId]) return;

      await hostHandleEventForDevice(act.deviceId, "tap");
    }

    // Tap handling (only when color shown; idle has no listener)
    fs.addEventListener("pointerdown", async (e) => {
      if (!roomCode) return;
      e.preventDefault();
      try {
        await actionsRef.push({ type:"tap", deviceId, at: now() });
      } catch {}
    });

    // Buttons
    btnRandom.onclick = () => { codeInput.value = genCode(); };

    btnJoin.onclick = async () => {
      const code = (codeInput.value||"").trim();
      if (!/^\d{5}$/.test(code)) { alert("Zadej 5 číslic."); return; }
      await joinOrCreate(code);
      joinCard.style.display = "none";
    };

    btnApply.onclick = async () => {
      if (!isHost) return;
      await initRoomDefaults();
      alert("Nastavení uloženo.");
    };

    btnReset.onclick = async () => {
      if (!isHost) return;
      const snap = await playersRef.get();
      const obj = snap.val() || {};
      const updates = {};
      for (const k of Object.keys(obj)) {
        updates[k + "/hits"] = 0;
        updates[k + "/miss"] = 0;
        updates[k + "/totalMs"] = 0;
      }
      await playersRef.update(updates);
      alert("Skóre vynulováno.");
    };

    btnStart.onclick = async () => {
      if (!isHost) return;

      // ✅ kontrola: hráčů <= herních telefonů (bez hosta)
      const stBefore = (await stateRef.get()).val() || {};
      const nPlayers = clamp(parseInt(playersCount.value,10)||4,2,10);

      const gameDevices = await getConnectedGameDevices();
      if (gameDevices.length < nPlayers) {
        alert(`Nelze spustit hru.\nHráčů: ${nPlayers}\nHerních telefonů: ${gameDevices.length}\n(Počítáno bez hosta)`);
        return;
      }

      hostRunning = true;

      // apply settings + reset round (ponechá UI + score reset v playersRef)
      await initRoomDefaults();

      // clear actions
      try { await actionsRef.remove(); } catch {}

      const gls = clamp(parseInt(gameLengthSec.value,10)||60,1,36000);
      const startedAt = now();
      const endsAt = startedAt + gls*1000;

      // ✅ vytvoř mapu deviceColors: přesně nPlayers telefonů dostane různé barvy, zbytek tmavý
      const init = buildInitialDeviceColors(gameDevices, nPlayers);

      await stateRef.update({
        phase:"running",
        hostRunning:true,
        round:0,
        gameStartedAt: startedAt,
        gameEndsAt: endsAt,

        // nové mapy
        deviceColors: init.dc,
        shownAtMap: init.shownAtMap
      });

      // local stop timer (host convenience)
      clearTimeout(stopTimer);
      stopTimer = setTimeout(async ()=>{
        try { await stateRef.update({ phase:"stopped", hostRunning:false }); } catch {}
      }, gls*1000 + 50);

      // ✅ host ticker na timeouty
      if (hostTickTimer) clearInterval(hostTickTimer);
      hostTickTimer = setInterval(()=>{ hostTick().catch(()=>{}); }, 150);
    };

    btnStop.onclick = async () => {
      if (!isHost) return;
      hostRunning = false;
      clearTimeout(stopTimer);
      if (hostTickTimer) { clearInterval(hostTickTimer); hostTickTimer = null; }
      await stateRef.update({ phase:"stopped", hostRunning:false });
    };
  </script>
</body>
</html>
